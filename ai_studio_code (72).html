<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>طفلي المسلم - رفيقك الإيماني</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
        body { font-family: 'Amiri', serif; -webkit-tap-highlight-color: transparent; }
        .quran-text { font-size: 1.6rem; line-height: 2.8; text-align: right; }
        .verse-container { display: flex; align-items: center; justify-content: space-between; background: #fff; border: 1px solid #e5e7eb; padding: 0.75rem 1.25rem; border-radius: 0.75rem; margin: 0.5rem 0; transition: all 0.3s ease; border-right-width: 5px; border-right-color: transparent; }
        .verse-container.mastered-verse { border-right-color: #10b981; background-color: #f0fdf4; }
        .verse-container.review-verse { border-right-color: #f59e0b; background-color: #fffbeb; }
        .verse-container.playing-verse { background: linear-gradient(120deg, #fef3c7 0%, #fde68a 100%); transform: scale(1.02); box-shadow: 0 4px 15px rgba(252, 211, 77, 0.4); }
        .bookmark-icon { cursor: pointer; font-size: 1.5rem; opacity: 0.5; transition: all 0.2s; }
        .bookmark-icon:hover { opacity: 1; transform: scale(1.2); }
        .nav-bottom { position: fixed; bottom: 0; left: 0; right: 0; background: linear-gradient(to right, #10b981, #3b82f6); backdrop-filter: blur(10px); z-index: 50; }
        .nav-item { display: flex; flex-direction: column; align-items: center; padding: 0.5rem; color: white; transition: all 0.3s ease; cursor: pointer; flex: 1; }
        .nav-item.active { background: rgba(255, 255, 255, 0.2); border-radius: 1rem 1rem 0 0; }
        .nav-text { font-size: 0.75rem; }
        .main-content { padding-bottom: 7rem; }
        .floating-animation { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
        .stats-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 1rem; padding: 1rem; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .game-option-btn { width: 100%; text-align: right; background-color: white; border: 2px solid #ddd; padding: 1rem; border-radius: 0.75rem; font-size: 1.1rem; font-weight: bold; transition: all 0.2s ease; }
        .recording-active { color: red; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .guide-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 100; display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .guide-content { background: white; border-radius: 1.5rem; padding: 2rem; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Splash Screen -->
    <div id="splashScreen" class="fixed inset-0 flex items-center justify-center z-[100] bg-gradient-to-br from-blue-500 to-purple-600">
        <div class="text-center text-white"><div class="text-8xl mb-6 floating-animation">🌙</div><h1 class="text-4xl font-bold mb-4" style="animation: fadeIn 1s ease-in-out;">طفلي المسلم</h1><p class="text-xl mb-8" style="animation: fadeIn 1s ease-in-out 0.5s;">رفيقك الإيماني</p><div class="w-64 h-2 bg-white bg-opacity-30 rounded-full mx-auto"><div id="loadingBar" class="h-2 bg-white rounded-full transition-all duration-1000" style="width: 0%"></div></div></div>
    </div>
    
    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <header class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-4 shadow-lg sticky top-0 z-40">
            <div class="container mx-auto flex items-center justify-between"><div class="flex items-center space-x-3 space-x-reverse"><div class="text-3xl">🌙</div><div><h1 class="text-xl font-bold">طفلي المسلم</h1><p class="text-sm opacity-80">مرحباً, <span id="childName" class="font-bold">يا صديقي</span></p></div></div><div class="flex items-center gap-2 bg-yellow-400 text-yellow-900 font-bold px-3 py-1 rounded-full"><span>🏆</span><span id="pointsDisplay">0</span></div></div>
        </header>
        
        <main class="main-content container mx-auto px-4 py-6">
            <section id="home" class="section-content"></section>
            <section id="quran" class="section-content hidden"></section>
            <section id="stories" class="section-content hidden"></section>
            <section id="duas" class="section-content hidden"></section>
            <section id="worship" class="section-content hidden"></section>
            <section id="asma" class="section-content hidden"></section>
            <section id="profile" class="section-content hidden"></section>
            <section id="games" class="section-content hidden"></section>
        </main>
        
        <nav class="nav-bottom">
            <div class="flex">
                <div class="nav-item active" onclick="showSection('home')">🏠<span class="nav-text">الرئيسية</span></div>
                <div class="nav-item" onclick="showSection('quran')">📖<span class="nav-text">القرآن</span></div>
                <div class="nav-item" onclick="showSection('stories')">📚<span class="nav-text">القصص</span></div>
                <div class="nav-item" onclick="showSection('duas')">🤲<span class="nav-text">الأدعية</span></div>
                <div class="nav-item" onclick="showSection('worship')">🕌<span class="nav-text">عباداتي</span></div>
                <div class="nav-item" onclick="showSection('asma')">💖<span class="nav-text">أسماء الله</span></div>
                <div class="nav-item" onclick="showSection('profile')">👤<span class="nav-text">ملفي</span></div>
                <div class="nav-item" onclick="showSection('games')">🎮<span class="nav-text">الألعاب</span></div>
            </div>
        </nav>
    </div>
    
    <div id="guideModal" class="guide-modal hidden"></div>

<script>
    // --- GLOBAL STATE & DATA ---
    const audioPlayer = new Audio();
    let currentPlaylist = [], currentTrackIndex = 0, isPlaying = false;
    let mediaRecorder, audioChunks = [], isCurrentlyRecording = false;
    let dailyProgress = { date: '', prayersMarkedToday: [], deedsMarkedToday: [] }; // Updated for new logic
    let currentGuideData = null, currentGuideStep = 0;
    let allSurahsMeta = []; // Fetched from API

    // Placeholder for audio feedback for games - REPLACE WITH ACTUAL SOUND FILE URLS
    const gameSoundCorrect = new Audio('https://cdn.pixabay.com/download/audio/2023/06/16/audio_0a3d3d92d5.mp3'); // Example sound for correct answer
    const gameSoundIncorrect = new Audio('https://cdn.pixabay.com/download/audio/2023/07/14/audio_b9f742291b.mp3'); // Example sound for incorrect answer
    const gameSoundPlay = new Audio(); // Audio player for Quranic recitations in games

    let userState = {
        points: 0,
        unlockedAchievements: [],
        childAvatar: '😊',
        guidesCompleted: [],
        storiesRead: 0,
        versesRecorded: 0,
        learnedAsma: [], // Stores indices of learned Asma
        hifzProgress: {}, // e.g., { '1-1': 'mastered', '1-2': 'review' }
        // Worship specific states
        prayerStreak: 0,
        lastPrayerStreakDate: null,
        dailyTargetDeeds: 3, // Default target for daily good deeds
        achievedDailyPrayerGoalToday: false,
        achievedDailyDeedGoalToday: false
    };

    // --- EDUCATIONAL & GAME DATA ---
    const dailyAyahs = ["وَمَن يَتَّقِ اللَّهَ يَجْعَل لَّهُ مَخْرَجًا", "إِنَّ مَعَ الْعُسْرِ يُسْرًا", "فَاذْكُرُونِي أَذْكُرْكُمْ", "وَقُولُوا لِلنَّاسِ حُسْنًا", "لَئِن شَكَرْتُمْ لَأَزِيدَنَّكُمْ"];
    const dailyDuasData = ["رَبَّنَا آتِنَا فِي الدُّنْيَا حَسَنَةً وَفِي الْآخِرَةِ حَسَنَةً وَقِنَا عَذَابَ النَّارِ", "اللَّهُمَّ إِنِّي أَسْأَلُكَ عِلْمًا نَافِعًا، وَرِزْقًا طَيِّبًا، وَعَمَلًا مُتَقَبَّلًا", "رَبِّ اشْرَحْ لِي صَدْرِي وَيَسِّرْ لِي أَمْرِي"];
    const storiesData = [{id:"adam",title:"آدَم",icon:"👤",content:"أول البشر، خلقه الله من طين وعلمه الأسماء كلها."},{id:"idris",title:"إِدْرِيس",icon:"✒️",content:"أول من خط بالقلم، رفعه الله مكاناً علياً."},{id:"nuh",title:"نُوح",icon:"🚢",content:"دعا قومه 950 سنة، وبنى السفينة لينجو والمؤمنون من الطوفان."},{id:"hud",title:"هُود",icon:"🌬️",content:"أُرسل إلى قوم عاد، الذين أهلكهم الله بالريح الشديدة."},{id:"salih",title:"صَالِح",icon:"🐫",content:"أُرسل إلى ثمود، وآيته الناقة التي قتلوها فأخذتهم الصيحة."},{id:"ibrahim",title:"إِبْرَاهِيم",icon:"🔥",content:"أبو الأنبياء، بنى الكعبة، ونجاه الله من النار."},{id:"lut",title:"لُوط",icon:"🏘️",content:"دعا قومه لترك الفواحش، فأهلكهم الله بمطر من حجارة."},{id:"ismail",title:"إِسْمَاعِيل",icon:"🐑",content:"ابن إبراهيم، فداه الله بكبش عظيم من الذبح."},{id:"ishaq",title:"إِسْحَاق",icon:"👨‍👦",content:"ابن إبراهيم، ومن نسله جاء أنبياء بني إسرائيل."},{id:"yaqub",title:"يَعْقُوب",icon:"🪜",content:"اسمه أيضاً إسرائيل، وهو أبو الأسباط الاثني عشر."},{id:"yusuf",title:"يُوسُف",icon:"✨",content:"عُرف بجماله وحكمته، وأصبح عزيز مصر بعد محنة طويلة."},{id:"ayyub",title:"أَيُّوب",icon:"🤕",content:"صبر على المرض وفقدان الأهل والمال، فكافأه الله."},{id:"shuaib",title:"شُعَيْب",icon:"⚖️",content:"أُرسل إلى أهل مدين، ودعاهم للعدل في الميزان."},{id:"musa",title:"مُوسَى",icon:"🌊",content:"كلم الله، ونجاه وقومه من فرعون بشق البحر."},{id:"harun",title:"هَارُون",icon:"🗣️",content:"أخو موسى، كان فصيح اللسان وساعده في دعوته."},{id:"dhulkifl",title:"ذُو الْكِفْل",icon:"🤲",content:"من الأنبياء الصابرين، وتكفل بأمور قومه."},{id:"dawud",title:"دَاوُود",icon:"🛡️",content:"آتاه الله الملك والحكمة، وألَانَ له الحديد."},{id:"sulaiman",title:"سُلَيْمَان",icon:"👑",content:"ورث داوود، وعلمه الله لغة الطير والحيوانات وسخر له الجن والريح."},{id:"ilyas",title:"إِلْيَاس",icon:"⛰️",content:"دعا قومه لعبادة الله وترك عبادة صنم اسمه بعل."},{id:"alyasa",title:"الْيَسَع",icon:"🙏",content:"من الأنبياء الأخيار الذين خلفوا إلياس في قومه."},{id:"yunus",title:"يُونُس",icon:"🐳",content:"ابتلعه الحوت ثم نجاه الله بدعائه."},{id:"zakariya",title:"زَكَرِيَّا",icon:"🙌",content:"تكفل بمريم العذراء، ورزقه الله بابنه يحيى في كبره."},{id:"yahya",title:"يَحْيَى",icon:"📜",content:"ابن زكريا، آتاه الله الحكمة وهو صبي."},{id:"isa",title:"عِيسَى",icon:"✨",content:"تكلم في المهد، وأحيا الموتى بإذن الله، ورفعه الله إليه."},{id:"muhammad",title:"مُحَمَّد",icon:"🕌",content:"خاتم الأنبياء والمرسلين، أُنزل عليه القرآن رحمة للعالمين."}];
    const duasData = [
        { title: 'أَذْكَارُ الصَّبَاحِ', text: 'أَصْبَحْنَا وَأَصْبَحَ الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ.', icon: '🌅', color: 'orange' },
        { title: 'أَذْكَارُ الْمَسَاءِ', text: 'أَمْسَيْنَا وَأَمْسَى الْمُلْكُ لِلَّهِ، وَالْحَمْدُ لِلَّهِ، لَا إِلَهَ إِلَّا اللَّهُ وَحْدَهُ لَا شَرِيكَ لَهُ، لَهُ الْمُلْكُ وَلَهُ الْحَمْدُ وَهُوَ عَلَى كُلِّ شَيْءٍ قَدِيرٌ.', icon: '🌙', color: 'purple' },
        { title: 'دُعَاءُ الطَّعَامِ', text: 'بِسْمِ اللَّهِ، فَإِذَا فَرَغَ فَلْيَقُلْ: الْحَمْدُ لِلَّهِ الَّذِي أَطْعَمَنِي هَذَا وَرَزَقَنِيهِ مِنْ غَيْرِ حَوْلٍ مِنِّي وَلَا قُوَّةٍ.', icon: '🍽️', color: 'green' },
        { title: 'دُعَاءُ النَّوْمِ', text: 'بِاسْمِكَ اللَّهُمَّ أَمُوتُ وَأَحْيَا.', icon: '😴', color: 'indigo' },
        { title: 'دُعَاءُ الْخُرُوجِ مِنَ الْمَنْزِلِ', text: 'بِسْمِ اللَّهِ، تَوَكَّلْتُ عَلَى اللَّهِ، وَلَا حَوْلَ وَلَا قُوَّةَ إِلَّا بِاللَّهِ.', icon: '🚪', color: 'blue' },
        { title: 'دُعَاءٌ لِلْوَالِدَيْنِ', text: 'رَّبِّ ارْحَمْهُمَا كَمَا رَبَّيَانِي صَغِيرًا.', icon: '👨‍👩‍👧‍👦', color: 'rose' },
        { title: 'دُعَاءُ طَلَبِ الْعِلْمِ', text: 'رَبِّ زِدْنِي عِلْمًا.', icon: '🧠', color: 'sky' },
        { title: 'دُعَاءُ دُخُولِ الْمَسْجِدِ', text: 'بِسْمِ اللهِ، وَالصَّلَاةُ وَالسَّلَامُ عَلَى رَسُولِ اللهِ، اللَّهُمَّ افْتَحْ لِي أَبْوَابَ رَحْمَتِكَ.', icon: '🕌', color: 'teal' },
        { title: 'دُعَاءُ الْخُرُوجِ مِنَ الْمَسْجِدِ', text: 'بِسْمِ اللهِ، وَالصَّلَاةُ وَالسَّلَامُ عَلَى رَسُولِ اللهِ، اللَّهُمَّ إِنِّي أَسْأَلُكَ مِنْ فَضْلِكَ.', icon: '🚶‍♂️', color: 'fuchsia' }
    ];
    const asmaAlHusnaData = [
        { name: 'الله', meaning: 'المألوه الواحد المعبود بحق الذي تفزع إليه الخلائق.' },
        { name: 'الرَّحْمَـٰنُ', meaning: 'صاحب الرحمة الواسعة الذي وسعت رحمته كل شيء.' },
        { name: 'الرَّحِيمُ', meaning: 'المنعم أبداً، المتفضل دوماً، فرحمته لا تنتهي.' },
        { name: 'الْمَلِكُ', meaning: 'المتصرف في ملكه كيف يشاء، المالك المطلق.' },
        { name: 'الْقُدُّوسُ', meaning: 'الطاهر المنزه عن كل عيب ونقص.' },
        { name: 'السَّلَامُ', meaning: 'واهب السلام والأمان لعباده، والذي سلمت ذاته من كل نقص.' },
        { name: 'الْمُؤْمِنُ', meaning: 'المؤمِّن لخلقه من كل خوف، والمصدق عباده ما وعدهم.' },
        { name: 'الْمُهَيْمِنُ', meaning: 'الرقيب على كل شيء، القائم على خلقه، والمطلع على خفايا الأمور.' },
        { name: 'الْعَزِيزُ', meaning: 'القوي الذي لا يُقهر، الغالب على أمره، وهو غالب كل شيء.' },
        { name: 'الْجَبَّارُ', meaning: 'الذي تنفذ مشيئته، ولا يخرج أحد عن تقديره، القاهر لخلقه على ما أراد.' },
        { name: 'الْمُتَكَبِّرُ', meaning: 'صاحب العظمة والكبرياء، المتعالي عن صفات الخلق.' },
        { name: 'الْخَالِقُ', meaning: 'المبدع لكل شيء، والمقدر له، والموجد للأشياء من العدم.' },
        { name: 'الْبَارِئُ', meaning: 'خلق الخلق بقدرته لا عن مثال سابق.' },
        { name: 'الْمُصَوِّرُ', meaning: 'صور جميع الموجودات، وأعطى كل شيء صورة خاصة تميزه.' },
        { name: 'الْغَفَّارُ', meaning: 'يغفر الذنوب ويستر العيوب في الدنيا والآخرة.' },
        { name: 'الْقَهَّارُ', meaning: 'الغالب الذي قهر خلقه بسلطانه وقدرته.' },
        { name: 'الْوَهَّابُ', meaning: 'المنعم على العباد، يهب بغير عوض، وكثير العطاء.' },
        { name: 'الرَّزَّاقُ', meaning: 'خلق الأرزاق، وأعطى كل الخلائق أرزاقها.' },
        { name: 'الْفَتَّاحُ', meaning: 'يفتح مغلق الأمور، ويسهل العسير.' },
        { name: 'الْعَلِيمُ', meaning: 'يعلم تفاصيل الأمور، ودقائق الأشياء، ولا تخفى عليه خافية.' },
        { name: 'الْقَابِضُ', meaning: 'يقتّر الرزق ويضيق على من يشاء.' },
        { name: 'الْبَاسِطُ', meaning: 'يوسع الرزق ويبسطه لمن يشاء.' },
        { name: 'الْخَافِضُ', meaning: 'يخفض من يستحق الخفض، ويذل من عصاه.' },
        { name: 'الرَّافِعُ', meaning: 'يرفع من يستحق الرفع، ويعز من أطاعه.' },
        { name: 'الْمُعِزُّ', meaning: 'يهب العزة لمن يشاء.' },
        { name: 'الْمُذِلُّ', meaning: 'يُذل من يشاء من أعدائه.' },
        { name: 'السَّمِيعُ', meaning: 'يسمع كل شيء، لا تخفى عليه الأصوات.' },
        { name: 'الْبَصِيرُ', meaning: 'يرى كل شيء، ما دق وما جل، ولا يعزب عنه بصره.' },
        { name: 'الْحَكَمُ', meaning: 'الحاكم العادل في خلقه، الذي لا يرد قضاؤه.' },
        { name: 'الْعَدْلُ', meaning: 'المنزه عن الظلم والجور، ويعطي كل ذي حق حقه.' },
        { name: 'اللَّطِيفُ', meaning: 'الرفيق بعباده، يرزق وييسر بألطافه الخفية.' },
        { name: 'الْخَبِيرُ', meaning: 'العالم بدقائق الأمور، وخفاياها، والمطلع على السرائر.' },
        { name: 'الْحَلِيمُ', meaning: 'الصَّبور على العصاة، الذي لا يعاجلهم بالعقوبة.' },
        { name: 'الْعَظِيمُ', meaning: 'ذي العظمة والجلال والكمال المطلق.' },
        { name: 'الْغَفُورُ', meaning: 'الذي يغفر الذنوب ويستر العيوب بكثرة.' },
        { name: 'الشَّكُورُ', meaning: 'يكافئ عباده بالثواب الجزيل على العمل القليل.' },
        { name: 'الْعَلِيُّ', meaning: 'ذو العلو المطلق في ذاته صفاته وأفعاله.' },
        { name: 'الْكَبِيرُ', meaning: 'ذو الكبرياء والعظمة الذي لا تحيط به الأوهام.' },
        { name: 'الْحَفِيظُ', meaning: 'يحفظ أعمال العباد، ويحفظ كل شيء من الزوال.' },
        { name: 'الْمُقِيتُ', meaning: 'الخالق لأقوات العباد، والمقدر لهم أرزاقهم.' },
        { name: 'الْحَسِيبُ', meaning: 'الكافي لعباده، والذي يحاسبهم على أعمالهم.' },
        { name: 'الْجَلِيلُ', meaning: 'ذو الجلال والعظمة والكبرياء.' },
        { name: 'الْكَرِيمُ', meaning: 'واسع العطاء، كثير الجود، والمعطي بلا حساب.' },
        { name: 'الرَّقِيبُ', meaning: 'المطلع على كل شيء، والذي يراقب أعمال العباد.' },
        { name: 'الْمُجِيبُ', meaning: 'يستجيب دعاء من يدعوه، ويقبل سؤال من يسأله.' },
        { name: 'الْوَاسِعُ', meaning: 'واسع العلم، واسع الرحمة، واسع الفضل.' },
        { name: 'الْحَكِيمُ', meaning: 'المتقن لتدبير أمور خلقه، الذي تظهر آثار حكمته في كل شيء.' },
        { name: 'الْوَدُودُ', meaning: 'المحب لعباده المؤمنين، والمحبوب في قلوبهم.' },
        { name: 'الْمَجِيدُ', meaning: 'ذو المجد، وهو الكرم واتساع الخير والصفات الكاملة.' },
        { name: 'الْبَاعِثُ', meaning: 'يُخرج الموتى من قبورهم يوم القيامة، ويرسل الرسل.' },
        { name: 'الشَّهِيدُ', meaning: 'المطلع على كل شيء، والذي شهد على كل شيء.' },
        { name: 'الْحَقُّ', meaning: 'الموجود بذاته، والذي لا شك في وجوده، وأمره كله حق.' },
        { name: 'الْوَكِيلُ', meaning: 'الكفيل بأمور خلقه، والذي يُعتمد عليه في كل شيء.' },
        { name: 'الْقَوِيُّ', meaning: 'ذو القوة التامة، الذي لا يعجزه شيء.' },
        { name: 'الْمَتِينُ', meaning: 'شديد القوة، الذي لا يحتاج في إمضاء حكمه إلى مدد.' },
        { name: 'الْوَلِيُّ', meaning: 'ناصر المؤمنين، والمتولي أمورهم ومصالحهم.' },
        { name: 'الْحَمِيدُ', meaning: 'المستحق لكل الحمد والثناء، والذي يحمد نفسه على نعمه.' },
        { name: 'الْمُحْصِي', meaning: 'العالم بكل شيء، والذي أحصى كل شيء بعلمه.' },
        { name: 'الْمُبْدِئُ', meaning: 'الذي أنشأ الأشياء واخترعها ابتداءً.' },
        { name: 'الْمُعِيدُ', meaning: 'يُعيد الخلق بعد فنائهم، ويُرجع كل شيء إلى أصله.' },
        { name: 'الْمُحْيِي', meaning: 'الذي يحيي الموتى، ويهب الحياة لمن يشاء.' },
        { name: 'الْمُمِيتُ', meaning: 'الذي يميت كل حي، ويقدر الموت على كل نفس.' },
        { name: 'الْحَيُّ', meaning: 'ذو الحياة الكاملة والدائمة التي لم تسبق بعدم ولا يلحقها زوال.' },
        { name: 'الْقَيُّومُ', meaning: 'القائم بنفسه، والذي يقوم به كل شيء، فلا ينام ولا يفوت.' },
        { name: 'الْوَاجِدُ', meaning: 'الموجود الذي لا يفتقر لوجوده لشيء، والغني الذي لا يحتاج لشيء.' },
        { name: 'الْمَاجِدُ', meaning: 'ذو المجد، وهو الكرم والعطاء والجود.' },
        { name: 'الْوَاحِدُ', meaning: 'المنفرد في ذاته صفاته، لا شريك له ولا مثيل.' },
        { name: 'الْأَحَدُ', meaning: 'المنفرد بالذات، الذي لا يدخل عليه أحد ولا يخرج منه شيء.' },
        { name: 'الصَّمَدُ', meaning: 'المقصود في الحوائج، الذي يصمد إليه كل شيء.' },
        { name: 'الْقَادِرُ', meaning: 'ذو القدرة التامة، الذي يقدر على فعل كل شيء.' },
        { name: 'الْمُقْتَدِرُ', meaning: 'شديد القدرة، الذي لا يعجزه شيء في الأرض ولا في السماء.' },
        { name: 'الْمُقَدِّمُ', meaning: 'يقدم من يشاء من خلقه، ويرفع منزلته.' },
        { name: 'الْمُؤَخِّرُ', meaning: 'يؤخر من يشاء، ويضع من يشاء في مرتبته.' },
        { name: 'الْأَوَّلُ', meaning: 'الذي لا يسبقه شيء، وهو أول كل شيء بالوجود.' },
        { name: 'الْآخِرُ', meaning: 'الذي لا يبقى شيء بعد فناء كل شيء، وهو آخر كل شيء.' },
        { name: 'الظَّاهِرُ', meaning: 'الذي ظهر وجوده بكل شيء، ودلت آياته على وجوده.' },
        { name: 'الْبَاطِنُ', meaning: 'الذي لا يدرك علمه أو حقيقته، المحيط بكل شيء خفاءً.' },
        { name: 'الْوَالِي', meaning: 'المتولي لأمور خلقه، والمسيطر على كل شيء.' },
        { name: 'الْمُتَعَالِي', meaning: 'ذو العلو المطلق، فوق كل شيء علواً.' },
        { name: 'الْبَرُّ', meaning: 'المحسن إلى خلقه، واسع العطاء والخير.' },
        { name: 'التَّوَّابُ', meaning: 'يقبل توبة عباده، ويوفقهم لها.' },
        { name: 'الْمُنْتَقِمُ', meaning: 'يعاقب المجرمين وينتقم منهم.' },
        { name: 'الْعَفُوُّ', meaning: 'المحب للصفح، الذي يمحو الذنوب والخطايا.' },
        { name: 'الرَّؤُوفُ', meaning: 'عظيم الرأفة والرحمة بالعباد.' },
        { name: 'مَالِكُ الْمُلْكِ', meaning: 'صاحب الملك كله، الذي يعطي الملك لمن يشاء ويمنعه.' },
        { name: 'ذُو الْجَلَالِ وَالْإِكْرَامِ', meaning: 'صاحب العظمة والكبرياء، والجود والعطاء.' },
        { name: 'الْمُقْسِطُ', meaning: 'العدل في حكمه، الذي يقسط بين عباده.' },
        { name: 'الْجَامِعُ', meaning: 'يجمع خلقه يوم القيامة، ويجمع صفات الكمال.' },
        { name: 'الْغَنِيُّ', meaning: 'الغني عن كل شيء، والذي لا يحتاج لشيء.' },
        { name: 'الْمُغْنِي', meaning: 'يغني عباده، ويقضي حوائجهم.' },
        { name: 'الْمَانِعُ', meaning: 'يمنع ما يشاء من الأشياء، ويحمي عباده.' },
        { name: 'الضَّارُّ', meaning: 'يصيب بالضر والشدة من يشاء من الكفار.' },
        { name: 'النُّورُ', meaning: 'يهدي به عباده، وهو نور السماوات والأرض.' },
        { name: 'الْهَادِي', meaning: 'يهدي عباده إلى الحق والصراط المستقيم.' },
        { name: 'الْبَدِيعُ', meaning: 'مبدع السماوات والأرض، خالقها على غير مثال سبق.' },
        { name: 'الْبَاقِي', meaning: 'الدائم الذي لا يزول ولا يفنى.' },
        { name: 'الْوَارِثُ', meaning: 'يبقى بعد فناء كل شيء، ويرث ملكه لمن يشاء.' },
        { name: 'الرَّشِيدُ', meaning: 'الذي يرشد عباده إلى الحق، ويدلهم على الخير.' },
        { name: 'الصَّبُورُ', meaning: 'الذي لا يتعجل بالعقوبة، ويمهل الظالمين.' }
    ];
    const wuduSteps = [{ emoji: '👐', text: 'أَقُولُ بِسْمِ اللَّهِ وَأَنْوِي الْوُضُوءَ، ثُمَّ أَغْسِلُ كَفَّيَّ ثَلَاثَ مَرَّاتٍ.' }, { emoji: '👄', text: 'أَتَمَضْمَضُ ثَلَاثَ مَرَّاتٍ.' }, { emoji: '👃', text: 'أَسْتَنْشِقُ وَأَسْتَنْثِرُ ثَلَاثَ مَرَّاتٍ.' }, { emoji: '😊', text: 'أَغْسِلُ وَجْهِي كَامِلًا ثَلَاثَ مَرَّاتٍ.' }, { emoji: '💪', text: 'أَغْسِلُ يَدِيَ الْيُمْنَى ثُمَّ الْيُسْرَى إِلَى الْمِرْفَقِ.' }, { emoji: '👱‍♂️', text: 'أَمْسَحُ رَأْسِي مَرَّةً وَاحِدَةً.' }, { emoji: '👂', text: 'أَمْسَحُ أُذُنَيَّ مَرَّةً وَاحِدَةً.' }, { emoji: '🦶', text: 'أَغْسِلُ رِجْلِيَ الْيُمْنَى ثُمَّ الْيُسْرَى إِلَى الْكَعْبَيْنِ.' }, { emoji: '☝️', text: 'أَقُولُ: "أَشْهَدُ أَنْ لَا إِلَهَ إِلَّا اللَّهُ..."' }];
    const salatSteps = [{ emoji: '🧍‍♂️', text: 'أَقِفُ مُسْتَقْبِلًا الْقِبْلَةَ وَأُكَبِّرُ.' }, { emoji: '📖', text: 'أَقْرَأُ الْفَاتِحَةَ وَسُورَةً قَصِيرَةً.' }, { emoji: '🙇‍♂️', text: 'أَرْكَعُ وَأَقُولُ "سُبْحَانَ رَبِّيَ الْعَظِيمِ".' }, { emoji: '🧍‍♂️', text: 'أَعْتَدِلُ قَائِلًا "سَمِعَ اللَّهُ لِمَنْ حَمِدَهُ".' }, { emoji: '🧎‍♂️', text: 'أَسْجُدُ وَأَقُولُ "سُبْحَانَ رَبِّيَ الْأَعْلَى".' }, { emoji: '🧎‍♂️', text: 'أَجْلِسُ بَيْنَ السَّجْدَتَيْنِ.' }, { emoji: '🧎‍♂️', text: 'أَسْجُدُ مَرَّةً ثَانِيَةً.' }, { emoji: '🧍‍♂️', text: 'أَقُومُ لِلرَّكْعَةِ الثَّانِيَةِ.' }, { emoji: '🧎‍♂️', text: 'أَجْلِسُ لِلتَّشَهُّدِ.' }, { emoji: '👋', text: 'أُسَلِّمُ عَنْ يَمِينِي وَشِمَالِي.' }];
    const achievementsData = [
        { id: 'points100', title: 'مستكشف برونزي', desc: 'الحصول على 100 نقطة', icon: '🥉', condition: (state) => state.points >= 100 }, 
        { id: 'points500', title: 'عالم فضي', desc: 'الحصول على 500 نقطة', icon: '🥈', condition: (state) => state.points >= 500 }, 
        { id: 'points1000', title: 'خبير ذهبي', desc: 'الحصول على 1000 نقطة', icon: '🥇', condition: (state) => state.points >= 1000 }, 
        { id: 'wuduExpert', title: 'خبير الوضوء', desc: 'إكمال دليل الوضوء', icon: '💧', condition: (state) => state.guidesCompleted.includes('wudu') }, 
        { id: 'salatExpert', title: 'المصلي الخاشع', desc: 'إكمال دليل الصلاة', icon: '🕌', condition: (state) => state.guidesCompleted.includes('salat') }, 
        { id: 'storyTeller', title: 'راوي القصص', desc: 'قراءة 5 قصص', icon: '📚', condition: (state) => state.storiesRead >= 5 }, 
        { id: 'hifzMaster', title: 'حافظ متقن', desc: 'إتقان 10 آيات', icon: '✅', condition: (state) => Object.values(state.hifzProgress).filter(s => s === 'mastered').length >= 10 }, 
        { id: 'asmaLearner10', title: 'عارف بالأسماء (10)', desc: 'تعلم 10 أسماء من أسماء الله الحسنى', icon: '🌟', condition: (state) => state.learnedAsma.length >= 10 },
        { id: 'asmaLearnerAll', title: 'محيط بالأسماء (99)', desc: 'تعلم جميع أسماء الله الحسنى', icon: '💫', condition: (state) => state.learnedAsma.length >= 99 }
    ];
    const surahEmojiGameData = [{ emojis: "🐘 🐦 🪨", options: ["الفيل", "قريش", "الماعون"], answer: "الفيل" }, { emojis: "🗣️ 🔥 ⛓️", options: ["الهمزة", "المسد", "الكافرون"], answer: "المسد" }];
    let guessSurahGameData = { 
        allSurahs: [], 
        correctAnswer: '', 
        audioUrl: '',
        currentAyahText: '',
        currentAyahNumber: '',
        currentSurahName: '',
        correctSurahNumber: null 
    };

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', initializeApp);

    function initializeApp() {
        let progress = 0;
        const loadingBar = document.getElementById('loadingBar');
        const loadingInterval = setInterval(() => {
            progress += 10;
            if (loadingBar) loadingBar.style.width = progress + '%';
            if (progress >= 100) {
                clearInterval(loadingInterval);
                setTimeout(() => {
                    document.getElementById('splashScreen').style.display = 'none';
                    document.getElementById('mainApp').classList.remove('hidden');
                    loadUserData(); // Load user data first
                    checkChildName(); // Then check for child name
                    loadAllSections(); // Load content for all sections
                    showSection('home'); // Show the home section initially
                }, 500);
            }
        }, 120);
        audioPlayer.addEventListener('ended', playNextVerse);
    }

    // --- USER DATA MANAGEMENT ---
    function saveUserData() {
        try {
            localStorage.setItem('userState', JSON.stringify(userState));
            localStorage.setItem('dailyProgress', JSON.stringify(dailyProgress));
        } catch (e) {
            console.error("Failed to save data to localStorage", e);
        }
    }

    function loadUserData() {
        try {
            const savedState = localStorage.getItem('userState');
            if (savedState) {
                userState = JSON.parse(savedState);
                // Ensure new properties are initialized if they don't exist
                if (userState.learnedAsma === undefined) userState.learnedAsma = [];
                if (userState.prayerStreak === undefined) userState.prayerStreak = 0;
                if (userState.lastPrayerStreakDate === undefined) userState.lastPrayerStreakDate = null;
                if (userState.dailyTargetDeeds === undefined) userState.dailyTargetDeeds = 3; // Default target deeds
                if (userState.achievedDailyPrayerGoalToday === undefined) userState.achievedDailyPrayerGoalToday = false;
                if (userState.achievedDailyDeedGoalToday === undefined) userState.achievedDailyDeedGoalToday = false;
            } else {
                // Initialize userState with default values
                userState = {
                    points: 0,
                    unlockedAchievements: [],
                    childAvatar: '😊',
                    guidesCompleted: [],
                    storiesRead: 0,
                    versesRecorded: 0,
                    learnedAsma: [],
                    hifzProgress: {},
                    prayerStreak: 0,
                    lastPrayerStreakDate: null,
                    dailyTargetDeeds: 3,
                    achievedDailyPrayerGoalToday: false,
                    achievedDailyDeedGoalToday: false
                };
            }
        } catch (e) {
            console.error("Failed to parse userState from localStorage", e);
            // Fallback to default state in case of error
            userState = {
                points: 0,
                unlockedAchievements: [],
                childAvatar: '😊',
                guidesCompleted: [],
                storiesRead: 0,
                versesRecorded: 0,
                learnedAsma: [],
                hifzProgress: {},
                prayerStreak: 0,
                lastPrayerStreakDate: null,
                dailyTargetDeeds: 3,
                achievedDailyPrayerGoalToday: false,
                achievedDailyDeedGoalToday: false
            };
        }
        
        document.getElementById('pointsDisplay').textContent = userState.points;

        try {
            const savedProgress = JSON.parse(localStorage.getItem('dailyProgress'));
            const today = new Date().toISOString().slice(0, 10);
            if (savedProgress && savedProgress.date === today) {
                dailyProgress = savedProgress;
                // Ensure inner structures exist for today's progress
                if (!dailyProgress.prayersMarkedToday) dailyProgress.prayersMarkedToday = [];
                if (!dailyProgress.deedsMarkedToday) dailyProgress.deedsMarkedToday = [];
            } else {
                // Reset for a new day
                dailyProgress = { 
                    date: today, 
                    prayersMarkedToday: [], 
                    deedsMarkedToday: [] 
                };
                // Reset today's goal achievement flags
                userState.achievedDailyPrayerGoalToday = false;
                userState.achievedDailyDeedGoalToday = false;
            }
        } catch (e) {
            console.error("Failed to parse dailyProgress from localStorage", e);
            const today = new Date().toISOString().slice(0, 10);
            dailyProgress = { date: today, prayersMarkedToday: [], deedsMarkedToday: [] };
            userState.achievedDailyPrayerGoalToday = false;
            userState.achievedDailyDeedGoalToday = false;
        }
        saveUserData(); 
    }

    function checkChildName() {
        let name = localStorage.getItem('childName');
        if (!name) {
            name = prompt("أهلاً بك! ما هو اسمك يا صديقي؟", "بطل الإسلام");
            localStorage.setItem('childName', name || "بطل الإسلام");
        }
        document.getElementById('childName').textContent = name;
    }

    // --- CORE APP LOGIC & NAVIGATION ---
    function showSection(sectionId) {
        stopAudio();
        stopSpeaking();
        closeGuide();
        document.querySelectorAll('.section-content').forEach(s => s.classList.add('hidden'));
        document.getElementById(sectionId).classList.remove('hidden');
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            if (item.getAttribute('onclick')?.includes(`'${sectionId}'`)) {
                item.classList.add('active');
            }
        });
        window.scrollTo(0, 0);
        if (sectionId === 'home') loadHomePage();
        if (sectionId === 'profile') loadProfileSection();
    }

    function loadAllSections() {
        loadHomePage();
        loadQuranSection();
        loadWorshipSection();
        loadStoriesSection();
        loadDuasSection();
        loadAsmaSection();
        loadProfileSection();
        loadGamesSection();
    }

    function updatePoints(amount, isIncrement = false) {
        if (isIncrement) {
            userState.points += amount;
        } else {
            userState.points = amount;
        }
        document.getElementById('pointsDisplay').textContent = userState.points;
        if (isIncrement && amount > 0) {
            showNotification(`+${amount} نقطة! أحسنت!`, 'success');
        }
        checkAndUnlockAchievements(); // Check achievements whenever points update
        saveUserData(); // Save points
    }

    // --- SECTION LOADERS ---
    function loadHomePage() {
        const homeSection = document.getElementById('home');
        const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
        const versesForReview = Object.keys(userState.hifzProgress).filter(key => userState.hifzProgress[key] === 'review');
        const masteredCount = Object.values(userState.hifzProgress).filter(s => s === 'mastered').length;

        let hifzStatusHTML = `<div class="bg-blue-50 border-r-4 border-blue-400 p-4 rounded-lg">
            <h3 class="font-bold text-blue-800 mb-2">ابدأ رحلة الحفظ!</h3>
            <p class="text-sm text-blue-700">اذهب لقسم القرآن، استمع للآيات وسجلها بصوتك، ثم حدد الآيات التي أتقنتها أو تحتاج لمراجعة.</p>
        </div>`;

        if (versesForReview.length > 0) {
            hifzStatusHTML = `<div class="bg-amber-50 border-r-4 border-amber-400 p-4 rounded-lg">
                <h3 class="font-bold text-amber-800 mb-2">📝 آيات للمراجعة (${versesForReview.length})</h3>
                <div class="space-y-2 mt-2">
                    ${versesForReview.slice(0, 3).map(key => { // Show only first 3 for brevity
                        const [surahNum, ayahNum] = key.split('-');
                        const surahMeta = allSurahsMeta.find(s => s.number == surahNum);
                        const surahName = surahMeta ? surahMeta.name : 'سورة';
                        return `<div class="flex justify-between items-center bg-white p-2 rounded-md cursor-pointer hover:bg-amber-100" onclick="goToVerse(${surahNum}, ${ayahNum})">
                            <span>${surahName}: آية ${ayahNum}</span>
                            <span class="text-sm">مراجعة</span>
                        </div>`;
                    }).join('')}
                    ${versesForReview.length > 3 ? '<p class="text-xs text-blue-600 cursor-pointer" onclick="showSection(\'quran\');">... المزيد</p>' : ''}
                </div>
            </div>`;
        }

        homeSection.innerHTML = `
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-4">
                <div class="stats-card">🕌<div class="text-xl font-bold">${dailyProgress.prayersMarkedToday.length}</div><div class="text-xs opacity-90">صلوات</div></div>
                <div class="stats-card">🏆<div class="text-xl font-bold">${userState.points}</div><div class="text-xs opacity-90">نقطة</div></div>
                <div class="stats-card">✅<div class="text-xl font-bold">${masteredCount}</div><div class="text-xs opacity-90">آيات متقنة</div></div>
                <div class="stats-card">🎖️<div class="text-xl font-bold">${userState.unlockedAchievements.length}</div><div class="text-xs opacity-90">أوسمة</div></div>
            </div>
            <div class="mb-4">${hifzStatusHTML}</div>
            <div style="background:linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);" class="rounded-xl p-4 text-center shadow-md mb-4"><h3 class="text-xl font-bold text-purple-700 mb-2">✨ آية اليوم</h3><p class="text-gray-800">${dailyAyahs[dayOfYear % dailyAyahs.length]}</p></div>
            <div style="background:linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);" class="rounded-xl p-4 text-center shadow-md"><h3 class="text-xl font-bold text-orange-700 mb-2">🤲 دعاء اليوم</h3><p class="text-gray-800">${dailyDuasData[dayOfYear % dailyDuasData.length]}</p></div>`;
    }

    function loadQuranSection() {
        document.getElementById('quran').innerHTML = `<div class="bg-white rounded-2xl shadow-xl p-6"><h2 class="text-3xl font-bold text-center text-green-700 mb-6">القرآن الكريم</h2>
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <div><label for="surahSelect" class="font-bold text-gray-700 mb-2 block">اختر السورة:</label><select id="surahSelect" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg" onchange="loadSurah()"></select></div>
                <div><label for="reciterSelect" class="font-bold text-gray-700 mb-2 block">القارئ:</label>
                <select id="reciterSelect" class="w-full p-3 border-2 border-gray-300 rounded-lg text-lg">
                    <option value="ar.alafasy">مشاري العفاسي</option>
                    <option value="ar.yasin_alzain">ياسين الجزائري</option>
                    <option value="ar.sudais">عبد الرحمن السديس</option>
                    <option value="ar.ajmy">أحمد بن علي العجمي</option>
                    <option value="ar.maheralmuaiqly">ماهر المعيقلي</option>
                    <option value="ar.minshawi_mujji">محمد صديق المنشاوي (مجود)</option>
                    <option value="ar.saad_alghamdi">سعد الغامدي</option>
                </select>
                </div>
            </div>
            <button onclick="playRecitation()" class="w-full bg-green-500 text-white py-3 px-6 rounded-lg font-semibold hover:bg-green-600 mb-6">استمع للتلاوة الكاملة للسورة</button>
            <div class="text-center mb-4 bg-gray-100 p-3 rounded-lg flex items-center justify-center gap-4">
                <button onclick="playPrevVerse()" class="text-3xl">⏮️</button>
                <button id="playBtn" onclick="togglePlayPause()" class="text-5xl text-green-600">▶️</button>
                <button onclick="playNextVerse()" class="text-3xl">⏭️</button>
                <button onclick="repeatCurrentAyah()" class="text-3xl">🔁</button>
            </div>
            <div id="quranTextWrapper" class="bg-yellow-50 p-4 rounded-lg"><div id="quranText"></div></div>
        </div>`;
        populateSurahSelect(document.getElementById('surahSelect'));
    }

    function loadWorshipSection() {
        const prayerNames = ['الفجر', 'الظهر', 'العصر', 'المغرب', 'العشاء'];
        const deedNames = ['مساعدة الوالدين', 'الصدقة', 'الابتسامة', 'قراءة القرآن', 'ذكر الله']; // Added 'ذكر الله' and potential for more
        const deedsPoints = 10; // Points per deed
        const prayerPoints = 5; // Points per prayer

        // Determine today's progress
        const completedPrayers = dailyProgress.prayersMarkedToday || [];
        const completedDeeds = dailyProgress.deedsMarkedToday || [];

        const allPrayersDoneToday = completedPrayers.length === prayerNames.length;
        const deedsProgress = completedDeeds.length;
        const deedsGoalMet = deedsProgress >= userState.dailyTargetDeeds;

        // Update daily goal flags in userState if not already set for today
        if (!userState.achievedDailyPrayerGoalToday && allPrayersDoneToday) {
            userState.achievedDailyPrayerGoalToday = true;
        }
        if (!userState.achievedDailyDeedGoalToday && deedsGoalMet) {
            userState.achievedDailyDeedGoalToday = true;
        }

        // Update streaks
        const today = new Date().toISOString().slice(0, 10);
        if (userState.lastPrayerStreakDate !== today) { // Only update if date is different from last recorded streak date
            if (allPrayersDoneToday) {
                if (userState.lastPrayerStreakDate === null || isDateOneDayBefore(userState.lastPrayerStreakDate, today)) {
                    userState.prayerStreak++;
                    userState.lastPrayerStreakDate = today;
                } else { // Streak broken
                    userState.prayerStreak = 1;
                    userState.lastPrayerStreakDate = today;
                }
            } else { // Prayers not all done today, streak might break tomorrow
                // We don't reset streak here, it will be naturally reset if next day is not completed.
                // However, if the streak was broken yesterday, we don't want to reset it if today is also broken.
                // For simplicity, we only increment or reset to 1 if today is completed and valid.
                // If not completed, the streak value remains as is until the next valid completion or reset.
                // A more robust approach would be to check for streak break on loading.
            }
        }

        // Save updated userState immediately for streaks and flags
        saveUserData();

        // Calculate bonus points for today
        let todayBonusPoints = 0;
        if (allPrayersDoneToday && !userState.achievedDailyPrayerGoalToday) { // Award prayer goal bonus only once per day
             todayBonusPoints += 20; // Bonus for completing all prayers
             userState.achievedDailyPrayerGoalToday = true; // Mark as achieved for today
        }
        if (deedsProgress >= userState.dailyTargetDeeds && !userState.achievedDailyDeedGoalToday) { // Award deed goal bonus only once per day
            todayBonusPoints += 15; // Bonus for completing deed goal
            userState.achievedDailyDeedGoalToday = true; // Mark as achieved for today
        }
        
        if(todayBonusPoints > 0) {
            updatePoints(todayBonusPoints, true); // Add bonus points
        }

        // --- Render HTML ---
        document.getElementById('worship').innerHTML = `
        <div class="bg-white rounded-2xl shadow-xl p-8">
            <h2 class="text-3xl font-bold text-center text-pink-700 mb-8">عِبَادَاتِي</h2>
            
            <h3 class="text-2xl font-bold text-blue-700 mb-4 flex items-center justify-center gap-2">
                💧 كَيْفَ أَتَوَضَّأُ؟
                <span class="text-sm font-normal text-gray-500">(تعلم الوضوء)</span>
            </h3>
            <button onclick="showGuide('wudu')" class="w-full bg-gradient-to-r from-blue-400 to-blue-600 text-white p-4 rounded-lg text-center text-xl font-bold mb-8">
                📖 تعلم خطوات الوضوء
            </button>

            <h3 class="text-2xl font-bold text-green-700 mb-4 flex items-center justify-center gap-2">
                🕌 كَيْفَ أُصَلِّي؟
                <span class="text-sm font-normal text-gray-500">(تعلم الصلاة)</span>
            </h3>
            <button onclick="showGuide('salat')" class="w-full bg-gradient-to-r from-green-400 to-green-600 text-white p-4 rounded-lg text-center text-xl font-bold mb-12">
                📖 تعلم خطوات الصلاة
            </button>

            <hr class="my-8 border-t-2 border-gray-200">

            <h3 class="text-2xl font-bold text-indigo-700 mb-6 flex items-center justify-center gap-2">
                ✨ صَلَوَاتِي الْيَوْمَ 
                <span class="text-sm font-normal text-gray-500">(تحقيق الهدف اليومي)</span>
            </h3>
            <div class="flex justify-center items-center space-x-4 mb-6">
                <div class="flex items-center space-x-2">
                    <div class="text-2xl">🔥</div>
                    <div class="text-lg font-bold text-orange-600">${userState.prayerStreak}</div>
                    <div class="text-sm text-gray-600">يوم</div>
                </div>
                <div class="flex flex-col items-center">
                    <div class="flex justify-center gap-2 mb-2">
                        ${prayerNames.map(pName => {
                            const isCompleted = completedPrayers.includes(pName);
                            return `
                            <div 
                                id="prayer-${pName.toLowerCase()}"
                                onclick="handlePrayerClick('${pName}', ${prayerPoints})"
                                class="cursor-pointer p-3 rounded-full transition-all duration-300 
                                ${isCompleted ? 'bg-gradient-to-br from-green-400 to-green-500 shadow-md scale-110' : 'bg-gray-200 hover:bg-gray-300'}"
                                title="${pName}"
                            >
                                <svg class="h-8 w-8 fill-current ${isCompleted ? 'text-white' : 'text-gray-700'}">
                                    ${getPrayerIconSVG(pName)}
                                </svg>
                            </div>`;
                        }).join('')}
                    </div>
                    <div class="text-sm font-bold ${allPrayersDoneToday ? 'text-green-600' : 'text-gray-700'}">
                        ${allPrayersDoneToday ? '✅ جميع الصلوات اليوم' : `(${completedPrayers.length}/${prayerNames.length}) الصلوات المكتملة`}
                    </div>
                </div>
            </div>

            <hr class="my-8 border-t-2 border-gray-200">

            <h3 class="text-2xl font-bold text-purple-700 mb-6 flex items-center justify-center gap-2">
                ✨ أعمالي الصالحة اليوم 
                <span class="text-sm font-normal text-gray-500">(هدف ${userState.dailyTargetDeeds} أعمال)</span>
            </h3>
            <div class="flex flex-col items-center justify-center gap-4 mb-8">
                <div class="w-full max-w-md bg-gray-100 rounded-full h-6">
                    <div id="deedProgressBar" class="bg-yellow-500 h-6 rounded-full text-xs font-bold text-white text-center p-1 transition-all duration-500" style="width: ${(deedsProgress / userState.dailyTargetDeeds) * 100}%">
                        ${deedsProgress} / ${userState.dailyTargetDeeds}
                    </div>
                </div>
                <div class="text-sm font-bold ${deedsGoalMet ? 'text-green-600' : 'text-gray-700'}">
                    ${deedsGoalMet ? '✅ هدف الأعمال اليومي محقق!' : `(${deedsProgress}/${userState.dailyTargetDeeds}) أعمال صالحة`}
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                ${deedNames.map(dName => {
                    const isDone = completedDeeds.includes(dName);
                    return `
                    <div 
                        id="deed-${dName.toLowerCase().replace(/\s+/g, '')}"
                        onclick="handleDailyTask('${dName}', ${deedsPoints})"
                        class="cursor-pointer p-4 rounded-xl text-center transition-all duration-300 
                        ${isDone ? 'bg-gradient-to-br from-purple-400 to-purple-500 shadow-md scale-105' : 'bg-gray-100 hover:bg-gray-200'}
                        ${isDone && !userState.achievedDailyDeedGoalToday ? 'animate-bounce' : ''}
                        "
                        title="${dName}"
                    >
                        <div class="text-3xl mb-2">${getDeedIcon(dName)}</div>
                        <h4 class="font-bold text-sm ${isDone ? 'text-white' : 'text-gray-800'}">${dName}</h4>
                        ${isDone ? '<div class="absolute -top-2 -right-2 text-green-500 font-bold text-xs">✔</div>' : ''}
                    </div>`;
                }).join('')}
            </div>
        </div>`;
    }

    // Helper function to get prayer icons based on name
    function getPrayerIconSVG(prayerName) {
        switch(prayerName.toLowerCase()) {
            case 'الفجر': return '<path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm0 2c5.523 0 10 4.477 10 10s-4.477 10-10 10-10-4.477-10-10 4.477-10 10-10z"/><circle cx="12" cy="12" r="4"/>';
            case 'الظهر': return '<path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm0 2c5.523 0 10 4.477 10 10s-4.477 10-10 10-10-4.477-10-10 4.477-10 10-10zm-2 9a1 1 0 0 1 2 0v3a1 1 0 0 1-2 0v-3z"/>';
            case 'العصر': return '<path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm0 2c5.523 0 10 4.477 10 10s-4.477 10-10 10-10-4.477-10-10 4.477-10 10-10zm3 5a1 1 0 0 1 0 2h-6a1 1 0 0 1 0-2h6z"/>';
            case 'المغرب': return '<path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm0 2c5.523 0 10 4.477 10 10s-4.477 10-10 10-10-4.477-10-10 4.477-10 10-10zm-2 7a1 1 0 0 1 1-1h4a1 1 0 0 1 0 2h-4a1 1 0 0 1-1-1z"/>';
            case 'العشاء': return '<path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20zm0 2c5.523 0 10 4.477 10 10s-4.477 10-10 10-10-4.477-10-10 4.477-10 10-10zm3 5a1 1 0 0 1 0 2h-2v2a1 1 0 0 1-2 0v-4a1 1 0 0 1 1-1h3z"/>';
            default: return '<path d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20z"/>'; // Default fallback
        }
    }

    // Helper function to get deed icons (simple emojis for now)
    function getDeedIcon(deedName) {
        switch(deedName) {
            case 'مساعدة الوالدين': return '👨‍👩‍👧‍👦';
            case 'الصدقة': return '💰';
            case 'الابتسامة': return '😊';
            case 'قراءة القرآن': return '📖';
            case 'ذكر الله': return '📿';
            default: return '🌟';
        }
    }

    // General handler for marking prayers and deeds
    // 'itemName' is the name of the prayer or deed (e.g., 'الفجر', 'الابتسامة')
    // 'pointsValue' is points for a single item (prayer or deed)
    function handleTaskClick(itemName, pointsValue, isPrayer = false) {
        const today = new Date().toISOString().slice(0, 10);

        // Prevent interactions if date has changed and goals reset implicitly
        if (dailyProgress.date !== today) {
            showNotification("البيانات قديمة، يرجى إعادة تحميل الصفحة.", "warning");
            return;
        }

        let currentProgressArray;
        let isAlreadyDone = false;
        let relatedElementId = '';

        if (isPrayer) {
            currentProgressArray = dailyProgress.prayersMarkedToday;
            relatedElementId = `prayer-${itemName.toLowerCase()}`;
        } else {
            currentProgressArray = dailyProgress.deedsMarkedToday;
            relatedElementId = `deed-${itemName.toLowerCase().replace(/\s+/g, '')}`;
        }
        
        isAlreadyDone = currentProgressArray.includes(itemName);

        if (isAlreadyDone) {
            // Item is already marked for today, do nothing.
            // If unmarking is desired, UI and logic needs to be more complex.
            return; 
        }
        
        // Mark the item as done
        currentProgressArray.push(itemName);
        saveUserData(); // Save progress immediately after adding item

        // Update UI and grant points
        const itemElement = document.getElementById(relatedElementId);
        if (itemElement) {
            if (isPrayer) {
                itemElement.classList.add('bg-gradient-to-br', 'from-green-400', 'to-green-500', 'shadow-md', 'scale-110');
                itemElement.querySelector('svg').classList.add('text-white');
                itemElement.classList.remove('bg-gray-200', 'hover:bg-gray-300');
                itemElement.onclick = null; // Disable further clicks for this prayer today
                updatePoints(pointsValue, true); // Award points for each prayer

                // Check if all prayers are now done
                if (dailyProgress.prayersMarkedToday.length === 5) {
                    userState.achievedDailyPrayerGoalToday = true; // Mark goal as achieved
                    updatePoints(20, true); // Bonus for completing all prayers
                    showNotification("🎉 أحسنت! جميع الصلوات اليوم تمت.", "success");
                    saveUserData(); // Ensure state is saved before reloading UI
                    loadWorshipSection(); // Refresh UI to show goal achieved status and potentially update streak
                }
            } else { // Deed
                itemElement.classList.add('bg-gradient-to-br', 'from-purple-400', 'to-purple-500', 'shadow-md', 'scale-105');
                itemElement.querySelector('h4').classList.add('text-white');
                itemElement.querySelector('div').classList.add('text-white'); // Make icon white too
                itemElement.innerHTML += '<div class="absolute -top-2 -right-2 text-green-500 font-bold text-xs">✔</div>'; // Add checkmark
                itemElement.onclick = null; // Disable further clicks for this deed today
                updatePoints(pointsValue, true); // Award points for deed

                // Update deed progress bar and counter
                const currentDeedsCount = dailyProgress.deedsMarkedToday.length;
                const targetDeeds = userState.dailyTargetDeeds;
                const progressWidth = Math.min((currentDeedsCount / targetDeeds) * 100, 100);
                
                const progressBar = document.getElementById('deedProgressBar');
                if (progressBar) {
                    progressBar.style.width = `${progressWidth}%`;
                    progressBar.textContent = `${currentDeedsCount} / ${targetDeeds}`;
                    
                    // Add animation/highlight if goal is met
                    if (currentDeedsCount >= targetDeeds && !userState.achievedDailyDeedGoalToday) {
                        progressBar.classList.add('bg-gradient-to-br', 'from-purple-500', 'to-purple-600', 'animate-pulse');
                        userState.achievedDailyDeedGoalToday = true; // Mark goal as achieved
                        updatePoints(15, true); // Bonus for completing deed goal
                        showNotification("✨ بارك الله فيك! لقد حققت هدف الأعمال الصالحة لهذا اليوم.", "success");
                        saveUserData(); // Save updated state
                        loadWorshipSection(); // Refresh section to reflect goal met status on deed buttons
                    }
                }
            }
        }
    }

    // Specific click handlers calling the general handler
    function handlePrayerClick(prayerName, pointsValue) {
        handleTaskClick(prayerName, pointsValue, true);
    }

    function handleDailyTask(deedName, pointsValue) {
        handleTaskClick(deedName, pointsValue, false);
    }

    // Helper function to check if dateString1 is exactly one day before dateString2
    function isDateOneDayBefore(dateString1, dateString2) {
        if (!dateString1) return false; // Cannot compare if dateString1 is null or undefined
        const d1 = new Date(dateString1);
        const d2 = new Date(dateString2);
        // Normalize to start of day to avoid timezone issues if dates are from different times
        d1.setHours(0, 0, 0, 0); 
        d2.setHours(0, 0, 0, 0);
        const diffTime = d2.getTime() - d1.getTime();
        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
        return diffDays === 1;
    }


    function loadStoriesSection() {
        document.getElementById('stories').innerHTML = `<div class="bg-white rounded-2xl shadow-xl p-8"><h2 class="text-3xl font-bold text-center text-blue-700 mb-8">قصص الأنبياء والرسل</h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4" id="storiesContainer">${storiesData.map(story => `
                <div class="p-4 rounded-xl bg-gradient-to-br from-orange-100 to-amber-200 cursor-pointer text-center" onclick="showStoryModal('${story.id}')">
                    <div class="text-4xl mb-2">${story.icon}</div>
                    <h4 class="font-bold text-gray-800">${story.title}</h4>
                </div>`).join('')}
            </div>
        </div>`;
    }

    function loadDuasSection() {
        document.getElementById('duas').innerHTML = `<div class="bg-white rounded-2xl shadow-xl p-8"><h2 class="text-3xl font-bold text-center text-yellow-700 mb-8">الأدعية المأثورة</h2>
            <div id="duasContainer" class="grid md:grid-cols-2 gap-6">${duasData.map(dua => `
                <div class="p-6 rounded-xl border-2 bg-gradient-to-br from-${dua.color}-50 to-${dua.color}-100 border-${dua.color}-200">
                    <h3 class="text-lg font-bold text-${dua.color}-700 mb-3 flex items-center"><span class="text-2xl ml-2">${dua.icon}</span> ${dua.title}</h3>
                    <p class="text-gray-700 mb-4">${dua.text}</p>
                    <button onclick="speakText('${dua.text.replace(/'/g, "\\'").replace(/"/g, '\\"')}')" class="w-full bg-${dua.color}-500 text-white py-2 px-4 rounded-lg">🔊 استمع</button>
                </div>`).join('')}
            </div>
        </div>`;
    }

    function loadAsmaSection() {
        document.getElementById('asma').innerHTML = `<div class="bg-white rounded-2xl shadow-xl p-6"><h2 class="text-3xl font-bold text-center text-teal-600 mb-2">أسماء الله الحسنى</h2>
            <p class="text-center text-gray-500 mb-8">تعلم أسماء الله واكسب النقاط!</p>
            <div id="asma-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">${asmaAlHusnaData.map((item, index) => `
                <div onclick="showNameMeaning(${index})" class="p-4 rounded-lg text-center cursor-pointer ${userState.learnedAsma.includes(index) ? 'bg-gradient-to-br from-teal-100 to-green-100' : 'bg-gradient-to-br from-yellow-100 to-orange-100'}">
                    <p class="text-xl font-bold text-teal-800">${item.name}</p>
                    ${userState.learnedAsma.includes(index) ? '<span class="text-xs text-green-600 font-bold">✓ تعلمته</span>' : ''}
                </div>`).join('')}
            </div>
        </div>`;
    }

    function loadProfileSection() {
        document.getElementById('profile').innerHTML = `<div class="bg-white rounded-2xl shadow-xl p-6 text-center">
            <div onclick="showAvatarSelection()" class="relative inline-block cursor-pointer group">
                <div class="text-8xl bg-gray-200 rounded-full w-32 h-32 flex items-center justify-center mb-4">${userState.childAvatar}</div>
                <div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="text-white text-sm font-bold">تغيير الصورة</span>
                </div>
            </div>
            <h2 class="text-3xl font-bold">${localStorage.getItem('childName') || 'بطل الإسلام'}</h2>
            <p class="text-xl text-yellow-500 font-bold mb-8">🏆 ${userState.points} نقطة</p>
            <h3 class="text-2xl font-bold text-gray-700 mb-4 border-t pt-6">الأوسمة التي حصلت عليها</h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">${achievementsData.map(ach => {
                const isUnlocked = userState.unlockedAchievements.includes(ach.id);
                return `<div class="p-4 rounded-lg text-center ${isUnlocked ? 'bg-green-100' : 'bg-gray-100 opacity-50'}">
                    <div class="text-5xl mb-2">${ach.icon}</div>
                    <h4 class="font-bold ${isUnlocked ? 'text-green-800' : 'text-gray-700'}">${ach.title}</h4>
                    <p class="text-xs text-gray-500">${ach.desc}</p>
                </div>`;
            }).join('')}</div>
        </div>`;
    }

    function loadGamesSection() {
        document.getElementById('games').innerHTML = `<div class="bg-white rounded-2xl shadow-xl p-6"><h2 class="text-3xl font-bold text-center text-indigo-700 mb-8">🎮 الألعاب التعليمية</h2>
            <div class="space-y-4" id="games-menu">
                <div onclick="startEmojiGame()" class="bg-blue-500 text-white p-6 rounded-lg text-center text-xl font-bold cursor-pointer">لعبة: احزر السورة بالرموز</div>
                <div onclick="startCompleteTheAyahGame()" class="bg-green-500 text-white p-6 rounded-lg text-center text-xl font-bold cursor-pointer">لعبة: أكمل الآية</div>
                <div onclick="startListenAndGuessGame()" class="bg-purple-500 text-white p-6 rounded-lg text-center text-xl font-bold cursor-pointer">لعبة: استمع وخمن السورة</div>
            </div>
            <div id="game-board" class="hidden"></div>
        </div>`;
    }

    // --- FEATURE FUNCTIONS (Quran, Worship, Asma, Profile, Achievements, etc.) ---
    async function populateSurahSelect(selectElement) {
        try {
            if (allSurahsMeta.length === 0) {
                const res = await fetch('https://api.alquran.cloud/v1/meta');
                const data = await res.json();
                allSurahsMeta = data.data.surahs.references;
            }
            selectElement.innerHTML = allSurahsMeta.map(s => `<option value="${s.number}">${s.number}. ${s.name}</option>`).join('');
            // Load last read surah or default to Surah Al-Fatiha (1)
            const lastRead = JSON.parse(localStorage.getItem('lastReadVerse')) || { surah: 1, ayah: 1 };
            selectElement.value = lastRead.surah;
            await loadSurah();
        } catch (e) {
            console.error("Failed to load surah list", e);
            selectElement.innerHTML = '<option value="1">1. الفاتحة</option>'; // Fallback
            await loadSurah();
        }
    }
    
    async function loadSurah() {
        stopAudio();
        const surahNumber = document.getElementById('surahSelect').value;
        const reciterValue = document.getElementById('reciterSelect').value; // Get selected reciter
        
        let reciterFolder = "";
        // Existing reciters
        if (reciterValue === "ar.alafasy") {
            reciterFolder = "Alafasy_64kbps";
        } else if (reciterValue === "ar.yasin_alzain") {
            reciterFolder = "YaseenAlJazairi_64kbps"; 
        } 
        // New reciters - common folder names from everyayah.com
        else if (reciterValue === "ar.sudais") { // Abdul Rahman Al-Sudais
            reciterFolder = "Sudais_64kbps";
        } else if (reciterValue === "ar.ajmy") { // Ahmed bin Ali Al-Ajmi
            reciterFolder = "Ajamy_64kbps";
        } else if (reciterValue === "ar.maheralmuaiqly") { // Maher Al-Muaiqly
            reciterFolder = "MaherAlMuaiqly_64kbps";
        } else if (reciterValue === "ar.minshawi_mujji") { // Mohamed Siddiq Al-Minshawi (Mujawwad)
            reciterFolder = "Minshawi_Mujawwad_64kbps";
        } else if (reciterValue === "ar.saad_alghamdi") { // Saad Al-Ghamdi
            reciterFolder = "AlGhamdi_64kbps";
        }
        else {
            reciterFolder = "Alafasy_64kbps"; // Default to Alafasy if unknown value
        }

        const quranTextDiv = document.getElementById('quranText');
        quranTextDiv.innerHTML = '<p class="text-center py-10">جاري تحميل السورة...</p>';

        try {
            // FIX: Use textResponse instead of response
            const textResponse = await fetch(`https://api.alquran.cloud/v1/surah/${surahNumber}`);
            const textData = await textResponse.json(); // Corrected line

            if (textData.code !== 200) throw new Error(textData.data);

            currentPlaylist = textData.data.ayahs.map(ayah => {
                const surahNumPadded = String(surahNumber).padStart(3, '0');
                const ayahNumPadded = String(ayah.numberInSurah).padStart(3, '0');
                // Construct URL using the determined reciterFolder
                return `https://everyayah.com/data/${reciterFolder}/${surahNumPadded}${ayahNumPadded}.mp3`;
            });

            quranTextDiv.innerHTML = textData.data.ayahs.map((ayah, index) => {
                const hifzKey = `${surahNumber}-${ayah.numberInSurah}`;
                const hifzStatus = userState.hifzProgress[hifzKey] || '';
                const hifzClass = hifzStatus === 'mastered' ? 'mastered-verse' : (hifzStatus === 'review' ? 'review-verse' : '');
                
                // Store last read verse for quick access
                localStorage.setItem('lastReadVerse', JSON.stringify({ surah: surahNumber, ayah: ayah.numberInSurah }));

                return `<div class="verse-container ${hifzClass}" data-verse-index="${index}" data-surah-number="${surahNumber}" data-ayah-number="${ayah.numberInSurah}">
                    <div class="flex-grow"><p class="quran-text">${ayah.text} <span class="text-green-700">﴿${ayah.numberInSurah}﴾</span></p></div>
                    <div class="flex flex-col items-center space-y-2 mr-4">
                        <button class="text-3xl transition-transform duration-200 hover:scale-125" onclick="toggleRecording(this, ${index})">🎤</button>
                    </div>
                </div>
                <div id="playback-controls-${index}" class="hidden bg-gray-100 p-2 rounded-lg text-center my-2 space-x-2 space-x-reverse"></div>`;
            }).join('');
        } catch (e) {
            console.error("Error loading Surah:", e);
            quranTextDiv.innerHTML = '<p class="text-center text-red-500 py-10">حدث خطأ أثناء تحميل السورة. يرجى المحاولة مرة أخرى.</p>';
        }
    }
    
    function playRecitation() {
        if (currentPlaylist.length > 0) playTrack(0);
    }
    
    function togglePlayPause() {
        if (isPlaying) {
            audioPlayer.pause();
        } else {
            if (audioPlayer.src) {
                audioPlayer.play();
            } else {
                playRecitation();
            }
        }
        isPlaying = !isPlaying;
        document.getElementById('playBtn').textContent = isPlaying ? '⏸️' : '▶️';
    }

    function playTrack(index) {
        if (index < 0 || index >= currentPlaylist.length) {
            isPlaying = false;
            document.getElementById('playBtn').textContent = '▶️';
            return;
        }
        stopSpeaking(); // Ensure no speech synthesis is active
        currentTrackIndex = index;
        audioPlayer.src = currentPlaylist[index];
        audioPlayer.play();
        isPlaying = true;
        document.getElementById('playBtn').textContent = '⏸️';
        updateHighlight(index);
    }
    
    function playNextVerse() { playTrack(currentTrackIndex + 1); }
    function playPrevVerse() { playTrack(currentTrackIndex - 1); }
    function repeatCurrentAyah() { playTrack(currentTrackIndex); }

    function updateHighlight(index) {
        document.querySelectorAll('.verse-container').forEach(v => v.classList.remove('playing-verse'));
        if (index > -1 && index < currentPlaylist.length) {
            const verseEl = document.querySelector(`[data-verse-index='${index}']`);
            if (verseEl) {
                verseEl.classList.add('playing-verse');
                verseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    }
    
    async function toggleRecording(button, verseIndex) {
        if (isCurrentlyRecording) {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
        } else {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = event => {
                    if (event.data.size > 0) { // Only push if there's data
                        audioChunks.push(event.data);
                    }
                };

                mediaRecorder.onstop = () => {
                    isCurrentlyRecording = false;
                    button.textContent = '🎤';
                    button.classList.remove('recording-active');
                    const blob = new Blob(audioChunks, { type: 'audio/wav' }); // WAV format for better compatibility
                    const audioUrl = URL.createObjectURL(blob);
                    
                    const verseEl = document.querySelector(`[data-verse-index='${verseIndex}']`);
                    const surahNum = verseEl.dataset.surahNumber;
                    const ayahNum = verseEl.dataset.ayahNumber;
                    
                    document.getElementById(`playback-controls-${verseIndex}`).classList.remove('hidden');
                    document.getElementById(`playback-controls-${verseIndex}`).innerHTML = `
                        <div class="flex justify-center flex-wrap gap-2">
                            <button onclick="markVerseStatus(this, ${surahNum}, ${ayahNum}, 'mastered')" class="bg-green-500 text-white text-sm py-1 px-3 rounded-md">أتقنتها (+15)</button>
                            <button onclick="markVerseStatus(this, ${surahNum}, ${ayahNum}, 'review')" class="bg-amber-500 text-white text-sm py-1 px-3 rounded-md">للمراجعة</button>
                            <button onclick="playRecordedAudio('${audioUrl}')" class="bg-blue-500 text-white text-sm py-1 px-3 rounded-md">اسمع صوتي</button>
                        </div>`;
                    
                    stream.getTracks().forEach(track => track.stop()); // Release camera and microphone resources
                    audioChunks = []; // Clear chunks for next recording
                };
                
                isCurrentlyRecording = true;
                button.textContent = '⏹️';
                button.classList.add('recording-active');
                mediaRecorder.start();

            } catch (err) {
                console.error("Mic error:", err);
                showNotification('لم تسمح باستخدام الميكروفون أو هناك مشكلة في الجهاز.', 'error');
                isCurrentlyRecording = false;
                button.textContent = '🎤';
                button.classList.remove('recording-active');
            }
        }
    }

    function playRecordedAudio(url) {
        stopAudio();
        audioPlayer.src = url;
        audioPlayer.play();
    }
    
    function markVerseStatus(button, surahNum, ayahNum, status) {
        const hifzKey = `${surahNum}-${ayahNum}`;
        const oldStatus = userState.hifzProgress[hifzKey];
        
        userState.hifzProgress[hifzKey] = status;
        
        if (status === 'mastered' && oldStatus !== 'mastered') {
            updatePoints(15, true);
            showNotification('ما شاء الله! آية متقنة', 'success');
        } else if (status === 'review') {
            showNotification('تم تحديد الآية للمراجعة', 'info');
        }
        
        button.parentElement.innerHTML = '<p class="text-sm text-gray-600 p-1">تم الحفظ!</p>';
        saveUserData();
        loadHomePage(); // Update home page to show updated mastered count
        loadSurah(); // Refresh current surah to show new visual states (mastered/review)
    }
    

    function showGuide(guideType) {
        currentGuideData = (guideType === 'wudu') ? wuduSteps : salatSteps;
        currentGuideStep = 0;
        document.getElementById('guideModal').classList.remove('hidden');
        renderGuideStep();
    }

    function renderGuideStep() {
        const step = currentGuideData[currentGuideStep];
        document.getElementById('guideModal').innerHTML = `<div class="guide-content">
            <p class="text-sm font-bold text-gray-500 mb-4">الْخُطْوَةُ ${currentGuideStep + 1}/${currentGuideData.length}</p>
            <div class="text-8xl mb-6">${step.emoji}</div>
            <p class="text-xl leading-relaxed">${step.text}</p>
            ${currentGuideStep === currentGuideData.length - 1 ?
                `<button onclick="finishGuide()" class="bg-blue-500 text-white w-full py-3 mt-4 rounded-lg font-bold">أَنْهَيْتُ! (+50)</button>` :
                `<button onclick="nextGuideStep()" class="bg-blue-500 text-white w-full py-3 mt-4 rounded-lg font-bold">التَّالِي</button>`
            }<button onclick="closeGuide()" class="text-gray-500 mt-4">إِغْلَاق</button>
        </div>`;
    }

    function nextGuideStep() {
        if (currentGuideStep < currentGuideData.length - 1) {
            currentGuideStep++;
            renderGuideStep();
        }
    }

    function finishGuide() {
        const type = (currentGuideData === wuduSteps) ? 'wudu' : 'salat';
        if (!userState.guidesCompleted.includes(type)) {
            userState.guidesCompleted.push(type);
            updatePoints(50, true);
        }
        closeGuide();
    }

    function closeGuide() {
        const modal = document.getElementById('guideModal');
        if(modal) modal.classList.add('hidden');
        currentGuideData = null;
    }

    function showStoryModal(storyId) {
        const story = storiesData.find(s => s.id === storyId);
        if (!story) return;
        
        // Increment stories read count only if it's a new story read
        if (!userState.storiesRead) userState.storiesRead = 0; // Initialize if not set
        userState.storiesRead++;
        
        checkAndUnlockAchievements(); // Check if this unlocks an achievement
        saveUserData(); // Save the updated count
        
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[99] p-4';
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        modal.innerHTML = `<div class="bg-white rounded-2xl p-6 max-w-2xl w-full text-center">
            <div class="text-6xl mb-4">${story.icon}</div>
            <h3 class="text-3xl font-bold">${story.title} عليه السلام</h3>
            <p class="text-xl leading-loose my-6">${story.content}</p>
            <button onclick="this.closest('.fixed').remove()" class="bg-red-500 text-white py-2 px-6 rounded-lg">إغلاق</button>
        </div>`;
        document.body.appendChild(modal);
    }
    
    function showNameMeaning(index) {
        const item = asmaAlHusnaData[index];
        const isLearned = userState.learnedAsma.includes(index);
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[99] p-4';
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        modal.innerHTML = `<div class="bg-white rounded-2xl p-6 max-w-sm w-full text-center">
            <h3 class="text-4xl font-bold text-teal-600">${item.name}</h3>
            <p class="text-lg my-6">${item.meaning}</p>
            <button onclick="learnName(${index}, this)" class="w-full bg-green-500 text-white py-3 rounded-lg font-semibold hover:bg-green-600 disabled:bg-gray-400" ${isLearned ? 'disabled' : ''}>
                ${isLearned ? '👍 لقد تعلمته' : 'تعلمت الاسم! (+5)'}
            </button>
            <button onclick="this.closest('.fixed').remove()" class="mt-4 w-full bg-gray-300 text-gray-800 py-2 rounded-lg">إغلاق</button>
        </div>`;
        document.body.appendChild(modal);
    }
    
    function learnName(index, button) {
        if (!userState.learnedAsma.includes(index)) {
            userState.learnedAsma.push(index);
            updatePoints(5, true); // Add 5 points for each learned name
            if(button) {
                button.disabled = true;
                button.textContent = '👍 لقد تعلمته';
            }
            loadAsmaSection(); // Refresh the Asma section to show the checkmark
            // Close the modal after a short delay
            setTimeout(() => {
                button.closest('.fixed').remove();
            }, 500);
        }
    }
    
    function showAvatarSelection() {
        const avatars = ['👧', '👦', '😊', '🥰', '🧑‍🎓', '🦸‍♀️', '🦸‍♂️', '💖'];
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[99] p-4';
        modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
        modal.innerHTML = `<div class="bg-white rounded-2xl p-6 max-w-md w-full text-center">
            <h3 class="text-2xl font-bold mb-6">اختر صورتك الرمزية</h3>
            <div class="grid grid-cols-4 gap-4">${avatars.map(av => `
                <div onclick="selectAvatar('${av}', this)" class="text-5xl cursor-pointer bg-gray-100 p-2 rounded-full hover:bg-yellow-200">${av}</div>`).join('')}
            </div>
        </div>`;
        document.body.appendChild(modal);
    }
    
    function selectAvatar(avatar, element) {
        userState.childAvatar = avatar;
        saveUserData();
        loadProfileSection();
        element.closest('.fixed').remove();
    }
    
    function checkAndUnlockAchievements() {
        achievementsData.forEach(ach => {
            if (!userState.unlockedAchievements.includes(ach.id) && ach.condition(userState)) {
                userState.unlockedAchievements.push(ach.id);
                showNotification(`وسام جديد! "${ach.title}" ${ach.icon}`, 'info');
            }
        });
        saveUserData(); // Save unlocked achievements
    }

    async function goToVerse(surahNum, ayahNum) {
        showSection('quran');
        // Wait for the Quran section to render and the surah to load
        await new Promise(resolve => setTimeout(resolve, 100)); 
        const surahSelect = document.getElementById('surahSelect');
        if (surahSelect && surahSelect.value != surahNum) {
            surahSelect.value = surahNum;
            await loadSurah(); // Load the selected surah
            await new Promise(resolve => setTimeout(resolve, 200)); // Give time for content to render
        }
        
        // Scroll to the specific verse
        const verseEl = document.querySelector(`[data-ayah-number="${ayahNum}"][data-surah-number="${surahNum}"]`);
        if(verseEl) {
            verseEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            // Add a temporary visual highlight for the verse
            verseEl.classList.add('playing-verse'); 
            setTimeout(() => verseEl.classList.remove('playing-verse'), 2000); // Remove highlight after 2 seconds
        }
    }
    
    // --- UTILITY & HELPER FUNCTIONS ---
    function stopAudio() {
        audioPlayer.pause();
        audioPlayer.src = '';
        isPlaying = false;
        const btn = document.getElementById('playBtn');
        if (btn) btn.textContent = '▶️';
        updateHighlight(-1); // Remove highlight from any playing verse
    }
    
    function speakText(text) {
        stopSpeaking(); // Stop any ongoing speech
        stopAudio(); // Stop any ongoing audio playback
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ar-SA'; // Arabic language
            // You might want to select a specific voice if available for Arabic
            // const voices = window.speechSynthesis.getVoices();
            // const arabicVoice = voices.find(voice => voice.lang === 'ar-SA');
            // if (arabicVoice) utterance.voice = arabicVoice;

            window.speechSynthesis.speak(utterance);
        } else {
            showNotification('التحدث غير مدعوم في هذا المتصفح.', 'error');
        }
    }
    
    function stopSpeaking() {
        if ('speechSynthesis' in window && window.speechSynthesis.speaking) {
            window.speechSynthesis.cancel(); // Cancel any speech currently in progress
        }
    }
    
    function showNotification(message, type) {
        const el = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-green-500' : (type === 'info' ? 'bg-blue-500' : (type === 'warning' ? 'bg-yellow-500' : 'bg-red-500'));
        el.className = `fixed top-20 right-4 ${bgColor} text-white px-6 py-4 rounded-lg shadow-lg z-[101] opacity-0 transition-opacity duration-500`;
        el.textContent = message;
        document.body.appendChild(el);
        // Fade in animation
        setTimeout(() => el.style.opacity = '1', 50);
        // Fade out and remove
        setTimeout(() => {
            el.style.opacity = '0';
            el.addEventListener('transitionend', () => el.remove());
        }, 3500);
    }

    // --- GAME FUNCTIONS ---
    function playSound(audioObject) {
        // Ensure the sound plays from the beginning even if it's already playing or paused
        audioObject.currentTime = 0; 
        audioObject.play().catch(e => console.error("Audio play failed:", e)); // Catch potential errors, e.g., user interaction required
    }

    function stopGameAudio() {
        gameSoundPlay.pause();
        gameSoundPlay.src = '';
    }

    function showGamesMenu() {
        stopGameAudio(); // Stop any Quran audio playing during games
        document.getElementById('game-board').classList.add('hidden');
        document.getElementById('games-menu').classList.remove('hidden');
    }

    // --- EMOJI GAME ---
    function startEmojiGame() {
        document.getElementById('games-menu').classList.add('hidden');
        document.getElementById('game-board').classList.remove('hidden');
        renderEmojiQuestion(0);
    }

    function renderEmojiQuestion(index) {
        const game = surahEmojiGameData[index];
        document.getElementById('game-board').innerHTML = `
            <div class="text-left mb-4">
                <button onclick="showGamesMenu()" class="bg-gray-500 text-white py-1 px-4 rounded-lg hover:bg-gray-600">→ عودة للألعاب</button>
            </div>
            <h3 class="text-xl font-bold text-center mb-4">ما هي السورة؟</h3>
            <div class="text-6xl text-center mb-6">${game.emojis}</div>
            <div class="space-y-3">${game.options.map(opt => `<button class="game-option-btn" onclick="checkEmojiAnswer(this, '${opt}' === '${game.answer}', ${index})">${opt}</button>`).join('')}</div>
            <div id="game-feedback" class="mt-4 text-center"></div>`;
    }

    function checkEmojiAnswer(button, isCorrect, index) {
        const feedbackDiv = document.getElementById('game-feedback');
        document.querySelectorAll('.game-option-btn').forEach(b => b.disabled = true); // Disable all options
        if (isCorrect) {
            button.classList.add('!bg-green-200');
            feedbackDiv.innerHTML = '<p class="text-green-600 font-bold">إجابة صحيحة! +15 نقطة</p>';
            updatePoints(15, true);
            playSound(gameSoundCorrect); // Play correct sound
            const nextIndex = index + 1;
            if (nextIndex < surahEmojiGameData.length) {
                feedbackDiv.innerHTML += `<button onclick="renderEmojiQuestion(${nextIndex})" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">التالي</button>`;
            } else {
                feedbackDiv.innerHTML += '<p class="font-bold mt-2">أكملت اللعبة!</p><button onclick="showGamesMenu()" class="mt-2 bg-gray-500 text-white px-4 py-2 rounded">العودة</button>';
            }
        } else {
            button.classList.add('!bg-red-200');
            feedbackDiv.innerHTML = '<p class="text-red-600 font-bold">إجابة خاطئة!</p><button onclick="showGamesMenu()" class="mt-2 bg-gray-500 text-white px-4 py-2 rounded">العودة</button>';
            playSound(gameSoundIncorrect); // Play incorrect sound
        }
    }
    
    // --- COMPLETE THE AYAH GAME ---
    async function startCompleteTheAyahGame() {
        const gameBoard = document.getElementById('game-board');
        gameBoard.innerHTML = '<p class="text-center py-10">جاري تجهيز سؤال...</p>';
        document.getElementById('games-menu').classList.add('hidden');
        gameBoard.classList.remove('hidden');
        try {
            // Fetch metadata first if not already loaded
            if (allSurahsMeta.length === 0) {
                const meta = await fetch('https://api.alquran.cloud/v1/meta');
                const metaData = await meta.json();
                allSurahsMeta = metaData.data.surahs.references;
            }
            
            let ayahs = [];
            let selectedSurah = null;
            let questionAyahText = '';
            let correctAyahText = '';

            // Select a surah that has enough ayahs for the game
            while (ayahs.length < 4) {
                 const randomSurahIndex = Math.floor(Math.random() * allSurahsMeta.length);
                 selectedSurah = allSurahsMeta[randomSurahIndex];
                 const response = await fetch(`https://api.alquran.cloud/v1/surah/${selectedSurah.number}`);
                 const data = await response.json();
                 ayahs = data.data.ayahs;
            }

            // Select a question and answer ayah (avoiding the last few ayahs to ensure there's a next one)
            const questionIndex = Math.floor(Math.random() * (ayahs.length - 2)); // Ensure index + 1 is valid
            questionAyahText = ayahs[questionIndex].text;
            correctAyahText = ayahs[questionIndex + 1].text;
            
            let options = [correctAyahText];
            // Get other ayahs to use as incorrect options
            let otherAyahs = ayahs.slice(0, questionIndex).concat(ayahs.slice(questionIndex + 2)).map(a => a.text);
            
            // Add incorrect options
            while (options.length < 4 && otherAyahs.length > 0) {
                let randomIndex = Math.floor(Math.random() * otherAyahs.length);
                options.push(otherAyahs.splice(randomIndex, 1)[0]);
            }
            options.sort(() => Math.random() - 0.5); // Shuffle options

            const optionsHTML = options.map(opt => {
                const isCorrect = (opt === correctAyahText);
                return `<button class="game-option-btn" onclick="checkAyahAnswer(this, ${isCorrect})">${opt}</button>`;
            }).join('');

            gameBoard.innerHTML = `
                <div class="text-left mb-4">
                    <button onclick="showGamesMenu()" class="bg-gray-500 text-white py-1 px-4 rounded-lg hover:bg-gray-600">→ عودة للألعاب</button>
                </div>
                <h3 class="text-xl font-bold text-center mb-2">ما هي الآية التالية؟</h3>
                <p class="text-center text-lg bg-yellow-100 p-4 rounded-lg mb-6 quran-text">${questionAyahText}</p>
                <div class="space-y-3">${optionsHTML}</div>
                <div id="game-feedback" class="mt-4 text-center"></div>`;
        } catch (e) {
            console.error("Game Error:", e);
            gameBoard.innerHTML = '<p class="text-red-500 text-center">خطأ في تجهيز اللعبة. حاول مجدداً.</p><button onclick="showGamesMenu()" class="mt-2 bg-gray-500 text-white px-4 py-2 rounded">العودة</button>';
        }
    }

    function checkAyahAnswer(button, isCorrect) {
        const feedbackDiv = document.getElementById('game-feedback');
        document.querySelectorAll('.game-option-btn').forEach(b => b.disabled = true); // Disable all options
        if (isCorrect) {
            button.classList.add('!bg-green-200');
            feedbackDiv.innerHTML = '<p class="text-green-600 font-bold">ممتاز! +20 نقطة</p>';
            updatePoints(20, true);
            playSound(gameSoundCorrect); // Play correct sound
            feedbackDiv.innerHTML += '<button onclick="startCompleteTheAyahGame()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">سؤال جديد</button>';
        } else {
            button.classList.add('!bg-red-200');
            feedbackDiv.innerHTML = '<p class="text-red-600 font-bold">إجابة غير صحيحة.</p><button onclick="showGamesMenu()" class="mt-2 bg-gray-500 text-white px-4 py-2 rounded">العودة</button>';
            playSound(gameSoundIncorrect); // Play incorrect sound
        }
    }

    // --- LISTEN AND GUESS GAME ---
    async function startListenAndGuessGame() {
        const board = document.getElementById('game-board');
        board.innerHTML = '<p class="text-center py-10">جاري تجهيز سؤال...</p>';
        document.getElementById('games-menu').classList.add('hidden');
        board.classList.remove('hidden');
        try {
            // Fetch metadata if not already loaded
            if (allSurahsMeta.length === 0) {
                const meta = await fetch('https://api.alquran.cloud/v1/meta');
                const metaData = await meta.json();
                allSurahsMeta = metaData.data.surahs.references;
            }

            // Select a random surah
            const randomSurah = allSurahsMeta[Math.floor(Math.random() * allSurahsMeta.length)];
            guessSurahGameData.correctSurahNumber = randomSurah.number;
            guessSurahGameData.currentSurahName = randomSurah.name; // Store name for later
            
            // Fetch ayahs for the selected surah to pick a random ayah
            const surahResponse = await fetch(`https://api.alquran.cloud/v1/surah/${randomSurah.number}`);
            const surahData = await response.json();
            const ayahs = surahData.data.ayahs;
            
            if (ayahs.length === 0) throw new Error("No ayahs found for this surah.");

            // Select a random ayah (e.g., from the first 50 to ensure variety and avoid very long ayahs for short clips)
            const randomAyahIndex = Math.floor(Math.random() * Math.min(ayahs.length, 50)); 
            const randomAyah = ayahs[randomAyahIndex];
            
            guessSurahGameData.currentAyahText = randomAyah.text;
            guessSurahGameData.currentAyahNumber = randomAyah.numberInSurah;
            
            // Construct audio URL for the chosen ayah (using Alafasy reciter)
            const surahNumPadded = String(randomSurah.number).padStart(3, '0');
            const ayahNumPadded = String(randomAyah.numberInSurah).padStart(3, '0');

            // Get the selected reciter to construct the correct URL
            const reciterValue = document.getElementById('reciterSelect').value; // Get selected reciter from the Quran screen
            let reciterFolder;
            if (reciterValue === "ar.alafasy") {
                reciterFolder = "Alafasy_64kbps";
            } else if (reciterValue === "ar.yasin_alzain") {
                // Corrected folder name for Yasin Al-Jazairi based on research.
                reciterFolder = "YaseenAlJazairi_64kbps"; 
            } else if (reciterValue === "ar.sudais") { 
                reciterFolder = "Sudais_64kbps";
            } else if (reciterValue === "ar.ajmy") { 
                reciterFolder = "Ajamy_64kbps";
            } else if (reciterValue === "ar.maheralmuaiqly") { 
                reciterFolder = "MaherAlMuaiqly_64kbps";
            } else if (reciterValue === "ar.minshawi_mujji") { 
                reciterFolder = "Minshawi_Mujawwad_64kbps";
            } else if (reciterValue === "ar.saad_alghamdi") { 
                reciterFolder = "AlGhamdi_64kbps";
            }
            else {
                reciterFolder = "Alafasy_64kbps"; // Default to Alafasy
            }
            guessSurahGameData.audioUrl = `https://everyayah.com/data/${reciterFolder}/${surahNumPadded}${ayahNumPadded}.mp3`;
            
            // Prepare options
            let options = [randomSurah.name];
            while (options.length < 4) {
                const wrongSurah = allSurahsMeta[Math.floor(Math.random() * allSurahsMeta.length)];
                if (!options.includes(wrongSurah.name)) {
                    options.push(wrongSurah.name);
                }
            }
            options.sort(() => Math.random() - 0.5); // Shuffle options

            const optionsHTML = options.map(o => 
                `<button class="game-option-btn" onclick="checkGuessSurahAnswer(this, '${o.replace(/'/g, "\\'")}')">${o}</button>`
            ).join('');

            board.innerHTML = `
                <div class="text-left mb-4">
                    <button onclick="showGamesMenu()" class="bg-gray-500 text-white py-1 px-4 rounded-lg hover:bg-gray-600">→ عودة للألعاب</button>
                </div>
                <h3 class="text-xl font-bold text-center mb-4">استمع وخمن السورة</h3>
                <div class="text-center mb-6">
                    <button onclick="playCurrentAyahAudio()" class="bg-green-500 text-white py-3 px-8 rounded-full text-2xl">🔊 استمع</button>
                </div>
                <div class="p-4 bg-yellow-100 rounded-lg mb-6 text-center quran-text">
                    <p>الآية: "${randomAyah.text}"</p>
                    <p class="text-sm">(${randomSurah.name}: ${randomAyah.numberInSurah})</p>
                </div>
                <div class="space-y-3">${optionsHTML}</div>
                <div id="game-feedback" class="mt-4 text-center"></div>`;
        } catch (e) {
            console.error("Listen and Guess Game Error:", e);
            board.innerHTML = '<p class="text-red-500 text-center">خطأ في تجهيز اللعبة. حاول مجدداً.</p><button onclick="showGamesMenu()" class="mt-2 bg-gray-500 text-white px-4 py-2 rounded">العودة</button>';
        }
    }

    function playCurrentAyahAudio() {
        if (guessSurahGameData.audioUrl) {
            gameSoundPlay.src = guessSurahGameData.audioUrl;
            gameSoundPlay.play();
        }
    }

    function checkGuessSurahAnswer(btn, answer) {
        document.querySelectorAll('.game-option-btn').forEach(b => b.disabled = true); // Disable all options
        const feedback = document.getElementById('game-feedback');
        if (answer === guessSurahGameData.currentSurahName) { // Use stored name
            btn.classList.add('!bg-green-200');
            feedback.innerHTML = `<p class="text-green-600 font-bold">صحيح! السورة هي ${guessSurahGameData.currentSurahName} (+25 نقطة)</p>`;
            updatePoints(25, true);
            playSound(gameSoundCorrect); // Play correct sound
            feedback.innerHTML += '<button onclick="startListenAndGuessGame()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">سؤال جديد</button>';
        } else {
            btn.classList.add('!bg-red-200');
            feedback.innerHTML = `<p class="text-red-600 font-bold">خطأ. السورة الصحيحة هي ${guessSurahGameData.currentSurahName}</p>`;
            playSound(gameSoundIncorrect); // Play incorrect sound
            feedback.innerHTML += '<button onclick="showGamesMenu()" class="mt-2 bg-gray-500 text-white px-4 py-2 rounded">العودة</button>';
        }
    }
</script>

</body>
</html>